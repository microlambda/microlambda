"use strict";(self.webpackChunkmila_docs=self.webpackChunkmila_docs||[]).push([[928],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=d(n),m=r,h=u["".concat(s,".").concat(m)]||u[m]||p[m]||o;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9760:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:1},i="The runner",l={unversionedId:"advanced/mila-runner",id:"advanced/mila-runner",title:"The runner",description:"The Microlambda runner is an essential component of the framework, and it is used under the hood by many Mila commands",source:"@site/docs/3-advanced/1-mila-runner.md",sourceDirName:"3-advanced",slug:"/advanced/mila-runner",permalink:"/docs/advanced/mila-runner",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Advanced concepts",permalink:"/docs/category/advanced-concepts"},next:{title:"Understand caching",permalink:"/docs/advanced/understand-caching"}},s={},d=[{value:"The targets",id:"the-targets",level:2},{value:"Topological and parallel",id:"topological-and-parallel",level:2},{value:"Daemon mode and log condition",id:"daemon-mode-and-log-condition",level:2}],c={toc:d};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"the-runner"},"The runner"),(0,r.kt)("p",null,"The Microlambda runner is an essential component of the framework, and it is used under the hood by many Mila commands\nsuch as build or deploy."),(0,r.kt)("p",null,"The runner is the component responsible for executing commands within the project. In a monorepo context, it is essential\nto be able to run commands in multiple workspaces and manage the order and concurrency in which they are launched."),(0,r.kt)("p",null,"As the project scales and includes numerous workspaces, it can be time-consuming and costly to rerun commands. A local\ncaching system can help address this issue."),(0,r.kt)("p",null,"Finally, to ensure a pleasant development experience, it is useful to be able to monitor files and rerun commands when\nchanges occur."),(0,r.kt)("p",null,"This is precisely the set of challenges that the Mila runner addresses."),(0,r.kt)("p",null,"It is important to understand how it works in order to configure it and customize caching\nbehavior and the order of command execution to suit your needs."),(0,r.kt)("h2",{id:"the-targets"},"The targets"),(0,r.kt)("p",null,"The runner operates by executing targets in the workspaces that contain them. These targets must be configured in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"mila.json")," configuration files."),(0,r.kt)("p",null,"A target is an entry in the 'targets' object, where the key is the name used by the runner (e.g., build), and the value\nis a configuration. This configuration includes:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"script")," or ",(0,r.kt)("inlineCode",{parentName:"td"},"cmd")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"yes")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"The command(s) or script to be executed")," : indicates to the runner the task to be performed. This can either be executing a script from the package.json (if it exists) or one or more shell commands.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"src")),(0,r.kt)("td",{parentName:"tr",align:null},"no"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Sources for the target"),": specifies all the files considered as sources, and thus used by the cache system to determine whether or not it is necessary to rerun the command.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"artifact")),(0,r.kt)("td",{parentName:"tr",align:null},"no"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Artifacts"),": lists all the files produced by the target. Used by the cache system to verify that the outputs exist and are still valid before skipping an execution.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"daemon")),(0,r.kt)("td",{parentName:"tr",align:null},"no"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Daemon"),": specifies whether the command should be treated as a daemon, meaning a process that does not exit. By default, the runner considers a target as successful when it exits with a status code of 0. However, in certain cases, such as a server listening on a port, the process does not exit. In such cases, it is necessary to instruct the runner on how to consider the command as either successful or failed.")))),(0,r.kt)("h2",{id:"topological-and-parallel"},"Topological and parallel"),(0,r.kt)("p",null,"Once a target is defined in one or more workspaces, you can execute it using the runner CLI with the command:\n",(0,r.kt)("inlineCode",{parentName:"p"},"yarn mila-runner run <target-name>")),(0,r.kt)("p",null,"By default, execution occurs in all packages in parallel with concurrency equal to half the available threads on the\nmachine. Concurrency can be adjusted using the ",(0,r.kt)("inlineCode",{parentName:"p"},"-c")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"--concurrency")," option to any integer value between 1 and the number\nof available threads on the machine."),(0,r.kt)("p",null,"Parallel mode is the default mode. However, sometimes it is necessary to execute a command while respecting the\ntopological order, meaning that the command should be executed in all dependencies of a workspace before executing it for\nthe workspace itself."),(0,r.kt)("p",null,"For this purpose, the Mila runner provides a ",(0,r.kt)("inlineCode",{parentName:"p"},"-t")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"--topological")," option that allows you to execute a build in topological\norder, i.e., from roots to leaves in the dependency tree."),(0,r.kt)("p",null,"The Microlambda scheduler will then schedule tasks with the highest concurrency that satisfies the topological constraints."),(0,r.kt)("p",null,"By default, the runner will attempt to run the target in all workspaces that contain it. However, it is possible to\nrestrict the scope of the command by providing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"--workspaces <comma-separated-list-of-workspace-names>")," option for parallel execution. This executes the command only in the specified workspaces.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"--to <comma-separated-list-of-workspace-names>")," option for topological execution. This executes the command only in the specified workspaces and their dependencies."))),(0,r.kt)("h2",{id:"daemon-mode-and-log-condition"},"Daemon mode and log condition"),(0,r.kt)("p",null,"By default, the runner considers a command successful only if it completes with a status code of 0. To modify this\nbehavior in order to execute processes that do not exit, you can enable daemon mode. To do this, you need to provide a\nlist of log conditions."),(0,r.kt)("p",null,"A log condition is an object containing the following keys:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"type")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"yes")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"success"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"failure")),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"Whether the execution should be considered as a failure or a success when the log condition is met.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"stdio")),(0,r.kt)("td",{parentName:"tr",align:null},"no"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"stdout"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"stderr"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"all")),(0,r.kt)("td",{parentName:"tr",align:null},"all"),(0,r.kt)("td",{parentName:"tr",align:null},"Look in stdout, stderr or both")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"matcher")),(0,r.kt)("td",{parentName:"tr",align:null},"no"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"contains"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"regex")),(0,r.kt)("td",{parentName:"tr",align:null},"contains"),(0,r.kt)("td",{parentName:"tr",align:null},"Check if the logs contains a substring, or if a regexp is matched")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"value")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"yes")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"-"),(0,r.kt)("td",{parentName:"tr",align:null},"The value to watch in the logs")))),(0,r.kt)("p",null,"Here is a configuration example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "targets" : {\n    "start": {\n      "script": "start",\n      "daemon": [\n        {\n          "type": "success",\n          "stdio": "all",\n          "matcher": "contains",\n          "value": "Server listening on"\n        },\n        {\n          "type": "failure",\n          "stdio": "stderr",\n          "matcher": "contains",\n          "value": "Server crashed"\n        }\n      ]\n    }\n  }\n}\n')))}p.isMDXComponent=!0}}]);