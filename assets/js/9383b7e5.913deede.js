"use strict";(self.webpackChunkmila_docs=self.webpackChunkmila_docs||[]).push([[628],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),d=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=d(a),m=r,h=c["".concat(s,".").concat(m)]||c[m]||p[m]||l;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var d=2;d<l;d++)i[d]=a[d];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},8001:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var n=a(7462),r=(a(7294),a(3905));const l={sidebar_position:2},i="Write your first handler",o={unversionedId:"tutorial-basics/first-handler",id:"tutorial-basics/first-handler",title:"Write your first handler",description:"On serverless project, AWS Lambda is used to handler events call triggers.",source:"@site/docs/1-tutorial-basics/2-first-handler.md",sourceDirName:"1-tutorial-basics",slug:"/tutorial-basics/first-handler",permalink:"/docs/tutorial-basics/first-handler",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Project structure",permalink:"/docs/tutorial-basics/project-structure"},next:{title:"Unit testing",permalink:"/docs/tutorial-basics/unit-testing"}},s={},d=[{value:"Simple handler",id:"simple-handler",level:2},{value:"Using @microlambda/handling",id:"using-microlambdahandling",level:2},{value:"Automatic response code",id:"automatic-response-code",level:3},{value:"CORS Configuration",id:"cors-configuration",level:3},{value:"Middleware",id:"middleware",level:3}],u={toc:d};function p(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"write-your-first-handler"},"Write your first handler"),(0,r.kt)("p",null,"On serverless project, AWS Lambda is used to handler events call triggers."),(0,r.kt)("p",null,"A wide diversity of triggers exists:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A HTTP call is performed on API Gateway"),(0,r.kt)("li",{parentName:"ul"},"A file is uploaded on a S3 bucket"),(0,r.kt)("li",{parentName:"ul"},"A periodic CRON trigger"),(0,r.kt)("li",{parentName:"ul"},"And many more...")),(0,r.kt)("h2",{id:"simple-handler"},"Simple handler"),(0,r.kt)("p",null,"To write an AWS Lambda handler in typescript you must export a function that receive the event\npassed from trigger, do some processing and optionally respond a answer."),(0,r.kt)("p",null,"The boilerplate depends on the trigger nature, but here is an example for an API Gateway POST API call:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import {APIGatewayEvent} from \"aws-lambda\";\nimport {vaildatePayload, saveInDatabase} from './helpers';\n\nexport const handler = async (event: APIGatewayEvent) => {\n  // Parse POST request payload from event\n  const payload = JSON.parse(event.body);\n  // Verify that event is valid using joi or a simmilar library\n  vaildatePayload(payload);\n  // Save in database\n  const uuid = await saveInDatabase(payload);\n  // Return response object for API Gateway, the format can be found in AWS docs\n  return {\n    statusCode: 201,\n    body: JSON.stringify({ id: uuid }),\n  };\n};\n")),(0,r.kt)("p",null,"This code works, but there are a few issues microlambda helps to solve:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If something throws in the handler, it will crash and no response will be given. The API gateway will answer ",(0,r.kt)("inlineCode",{parentName:"li"},"502")," ultimately."),(0,r.kt)("li",{parentName:"ul"},"You must parse, validate and serialize the request and response payload yourself"),(0,r.kt)("li",{parentName:"ul"},"No CORS configuration is used here. If you want to enable cross-origin resource sharing you must add yourself the correct headers in ",(0,r.kt)("em",{parentName:"li"},"every")," handler.")),(0,r.kt)("h2",{id:"using-microlambdahandling"},"Using @microlambda/handling"),(0,r.kt)("p",null,"Microlambda provides utilities to write API Gateway handlers faster."),(0,r.kt)("p",null,"The package ",(0,r.kt)("inlineCode",{parentName:"p"},"@microlambda/handling")," exports a second-order function that can be used to wrap you handler implementation."),(0,r.kt)("p",null,"It will automatically:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Try / catch the whole function body. If something fails unexpectedly, it will log the error on Cloudwatch and correctly answer ",(0,r.kt)("inlineCode",{parentName:"li"},"500 - Internal Server Error")," instead of crashing."),(0,r.kt)("li",{parentName:"ul"},"Parse request body from JSON into Javascript Object."),(0,r.kt)("li",{parentName:"ul"},"You can return only ",(0,r.kt)("inlineCode",{parentName:"li"},"void")," or the object value of the response body. The status code will be automatically set and the response serialized to JSON. If you need to overwrite defaults, you can still return the ",(0,r.kt)("inlineCode",{parentName:"li"},"{ statusCode: number, body: string}")," object expected by AWS API Gateway.")),(0,r.kt)("p",null,"Here is the same example than above, updated with microlambda helpers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import {handle} from '@microlambda/handling';\nimport {APIGatewayEvent} from \"aws-lambda\";\n\nexport const handler = handle(async (event: APIGatewayEvent) => {\n  vaildatePayload(event.body);\n  const uuid = await saveInDatabase(event.body);\n  return { id: uuid };\n});\n")),(0,r.kt)("h3",{id:"automatic-response-code"},"Automatic response code"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"200 (OK)"),": If the request is not a POST request and wrapped functions returns something other than ",(0,r.kt)("inlineCode",{parentName:"li"},"void")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"201 (Created)"),": If the request is a POST request"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"204 (No Content)"),": If the request is not a POST request and wrapped functions returns ",(0,r.kt)("inlineCode",{parentName:"li"},"void"))),(0,r.kt)("h3",{id:"cors-configuration"},"CORS Configuration"),(0,r.kt)("p",null,"You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"config")," method to set default CORS/headers"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { config } from '@microlambda/handling';\n\nconfig({ cors: true });\n\nexport const handler = handle(async () => {\n  return 'Hello world ! (with CORS headers)';\n});\n")),(0,r.kt)("p",null,"The CORS option can be either a boolean, to enable default CORS headers, or either an object to set custom CORS headers."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Header"),(0,r.kt)("th",{parentName:"tr",align:null},"Default value"),(0,r.kt)("th",{parentName:"tr",align:null},"JSPath in config"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Access-Control-Allow-Origin")),(0,r.kt)("td",{parentName:"tr",align:null},"Request origin"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"cors.origin"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Access-Control-Allow-Methods")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS', 'HEAD']")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"cors.methods"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Access-Control-Expose-Headers")),(0,r.kt)("td",{parentName:"tr",align:null},"All response headers"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"cors.exposeHeaders"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Access-Control-Allow-Headers")),(0,r.kt)("td",{parentName:"tr",align:null},"All request headers"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"cors.allowHeaders"))))),(0,r.kt)("h3",{id:"middleware"},"Middleware"),(0,r.kt)("p",null,"Wrapping your handlers in ",(0,r.kt)("inlineCode",{parentName:"p"},"handle")," function also enable microlambda middleware."),(0,r.kt)("p",null,"Learn more about in the ",(0,r.kt)("a",{parentName:"p",href:"./using-middleware"},"dedicated section")))}p.isMDXComponent=!0}}]);